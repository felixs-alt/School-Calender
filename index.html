
<head>
   <link rel="stylesheet" href="index.css">
   <script>
      async function schoolover(item){
         item.innerHTML = "SCHOOL OVER"
      }
      async function noschool(item){
         item.innerHTML = "NO SCHOOL"
      }
      function msToReadableTime(duration) {
         console.log(duration)
         var milliseconds = Math.floor((duration % 1000) / 100),
         minutes = Math.floor((duration / (1000 * 60)) % 60),
         hours = Math.floor((duration / (1000 * 60 * 60)) % 24);

         hours = (hours < 10) ? "0" + hours : hours;
         minutes = (minutes < 10) ? "0" + minutes : minutes;
         if (hours=='00'){
            return minutes + " minutes"
         } else {
            return hours + ":" + minutes
         }
      }
      dateObj = new Date()
      function updateTable(item,index){
         const time = (dateObj.toLocaleTimeString([], {hour12:false,hour:"numeric",minute: "2-digit" })).replace(':', '')
         console.log(item)
         if(parseInt(time)>parseInt(item.endTime.replace(':', ''))){return}
         if(lessonNumber > 3){return}
         if(parseInt(time)<parseInt(item.endTime.replace(':', '')) && parseInt(time)>parseInt(item.startTime.replace(':', ''))){lessonNumber=0}
         console.log(lessonNumber)
         const lesson = document.getElementById("lesson"+lessonNumber)
         if(lessonNumber==0){
            lesson.children[0].innerHTML = item.title
            lesson.children[1].innerHTML = item.startTime + " - " + item.endTime
            console.log(new Date(dateObj.toISOString().slice(0, -14)+item.end))
            lesson.children[2].innerHTML = "ends in "+msToReadableTime((new Date(dateObj.toISOString().slice(0, -14)+item.end)-dateObj))
            lesson.children[3].innerHTML = "Teacher: "+item.notes.tutors
            lesson.children[4].innerHTML = "Room: "+item.notes.roomInfo
         }else{
            lesson.children[0].innerHTML = item.title
            lesson.children[1].innerHTML = item.startTime + " - " + item.endTime
            lesson.children[3].innerHTML = "Teacher: "+item.notes.tutors
            lesson.children[4].innerHTML = "Room: "+item.notes.roomInfo
            lesson.children[2].innerHTML = "starts in "+msToReadableTime((new Date(dateObj.toISOString().slice(0, -14)+item.end)-dateObj))
         }
         lessonNumber++
      }
      async function update(){
         const response = await fetch("https://felixs-alt.github.io/School-Calender/table.json");
         const table = await response.json();
         const time = document.getElementById("time")
         const date = document.getElementById("date")
         date.innerHTML = dateObj.toDateString()
         time.innerHTML = "Lomma "+ dateObj.toLocaleTimeString([], {hour12:false,hour:"numeric",minute: "2-digit" })
         if (dateObj.getDay() % 6 === 0){
            for (let i = 0; i < 4; i++) {
               Array.from(document.getElementById("lesson"+i).children).forEach(noschool);
            }; 
            return
         } else {
            today = table[dateObj.getDay()-1]
         }
         console.log(table)
         lessonNumber=0
         if((dateObj.toLocaleTimeString([], {hour12:false,hour:"numeric",minute: "2-digit" })).replace(':', '')>parseInt(today[today.length - 1].endTime.replace(':', ''))){
            for (let i = 0; i < 4; i++) {
               Array.from(document.getElementById("lesson"+i).children).forEach(schoolover);
            }; 
         }
         today.forEach(updateTable)
         for (let i = 0; i < 4; i++) {
               Array.from(document.getElementById("events").children).forEach(element => {
                  if(!element.children[0].innerHTML){
                     Array.from(element.children).forEach(schoolover)
                  }
               });
         }; 
      }
      async function updateWeather(){
         let response = await fetch('https://api.openweathermap.org/data/2.5/weather?q=Lomma,se&appid=3ab048a5dff57c50e864e1484411f691') //you get your api key once you sign up for openweathermap.org
         weatherData = await response.json()
         const icon = document.getElementById("weather-icon")
         const temp = document.getElementById("temp")
         icon.src = "https://openweathermap.org/img/wn/"+weatherData.weather[0].icon+"@2x.png"
         temp.innerHTML=(Math.round((weatherData.main.temp - 273.15) * 100) / 100)+"Â°C"
      }
      window.addEventListener("load", async (event) => {
         await update()
         await updateWeather()
         setInterval(() => {
            window.dispatchEvent(new Event("update"))
         },5000);
         setInterval(() => {
            window.dispatchEvent(new Event("weather"))
         },300000);
      });
      window.addEventListener("weather", async (event) => {
         await updateWeather()
      });
      window.addEventListener("update", async (event) => {
         await update()
      });
   </script>
</head>
<body>
<div id="mobile"class="mobile-wrapper">

   <!--======= Header =======-->

   <header class="header">
      <div class="container">
         <h1>School Schedule</h1>
      </div>
   </header>
   <!--======= Today =======-->
   <section class="today-box" id="today-box">
      <span class="breadcrumb">Today</span>
      <h3 class="date-title"id="date"></h3>
      <div class="weather">
         <img id="weather-icon"></img>
         <p id="temp"></p>
         <p id="time">Lomma</p>
      </div>
   </section>

   <!--======= Upcoming Events =======-->

   <section class="upcoming-events">
      <div class="container">
         <h3>
            Lessons
         </h3>
         <div id="events" class="events-wrapper">
            <div id="lesson0" class="event active">
               <h5 class="event__point"></h5>
               <p class="event__time"></p>
               <span class="event__duration"></span>
               <p class="event__description"></p>
               <p class="event__description"></p>
            </div>
            <div id="lesson1"class="event">
               <h5 class="event__point"></h5>
               <p class="event__time"></p>
               <span class="event__duration"></span>
               <p class="event__description"></p>
               <p class="event__description"></p>
            </div>
            <div id="lesson2" class="event">
               <h5 class="event__point"></h5>
               <p class="event__time"></p>
               <span class="event__duration"></span>
               <p class="event__description"></p>
               <p class="event__description"></p>
            </div>
            <div id="lesson3"class="event">
               <h5 class="event__point"></h5>
               <p class="event__time"></p>
               <span class="event__duration"></span>
               <p class="event__description"></p>
               <p class="event__description"></p>
            </div>
         </div>
      </div>
   </section>
</div>
</body>
